<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cardano Predict ‚Ä¢ Prediction Market</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Copy all the styles from the previous version */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #020617;
      --bg-card: rgba(2, 6, 23, 0.8);
      --accent: #38bdf8;
      --accent-gradient: linear-gradient(135deg, #38bdf8, #0ea5e9);
      --success: #86efac;
      --error: #fca5a5;
      --warning: #fcd34d;
      --text-primary: #e5e7eb;
      --text-secondary: #94a3b8;
      --border: #1e293b;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at 10% 20%, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      padding: 24px;
      min-height: 100vh;
    }

    .dashboard {
      max-width: 1440px;
      margin: 0 auto;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--bg-card);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      border: 1px solid rgba(56, 189, 248, 0.2);
      margin-bottom: 32px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #38bdf8, #8b5cf6);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #38bdf8, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .testnet-badge {
      background: rgba(56, 189, 248, 0.2);
      color: #38bdf8;
      padding: 4px 12px;
      border-radius: 40px;
      font-size: 0.75rem;
    }

    .wallet-badge {
      background: rgba(56, 189, 248, 0.1);
      padding: 8px 16px;
      border-radius: 40px;
      border: 1px solid rgba(56, 189, 248, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--accent);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid rgba(56, 189, 248, 0.1);
      border-radius: 24px;
      padding: 24px;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .stat-title {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      background: rgba(56, 189, 248, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-card);
      border: 1px solid rgba(56, 189, 248, 0.1);
      border-radius: 24px;
      padding: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-title i {
      color: var(--accent);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 8px;
      display: block;
    }

    .input-wrapper {
      position: relative;
    }

    .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #64748b;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px 14px 44px;
      background: #0f172a;
      border: 2px solid var(--border);
      border-radius: 14px;
      color: white;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.3);
    }

    .btn-secondary {
      background: #1e293b;
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: white;
    }

    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .portfolio-item {
      background: rgba(56, 189, 248, 0.05);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
    }

    .portfolio-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      margin: 8px 0;
    }

    .leaderboard {
      margin-top: 16px;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px;
      border-bottom: 1px solid rgba(56, 189, 248, 0.1);
    }

    .log-container {
      background: #0f172a;
      border-radius: 14px;
      padding: 16px;
      min-height: 140px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85rem;
      border: 1px solid var(--border);
    }

    .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #2d3a4f 50%, #1e293b 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @media (max-width: 768px) {
      body { padding: 16px; }
      .navbar { flex-direction: column; }
      .stats-grid { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .portfolio-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <span class="logo-text">CardanoPredict</span>
        <span class="testnet-badge">
          <i class="fas fa-flask"></i> Preprod
        </span>
      </div>
      <div id="walletBadge" class="wallet-badge">
        <i class="fas fa-wallet"></i>
        <span>Connect Wallet</span>
      </div>
    </nav>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Total Value Locked</span>
          <div class="stat-icon"><i class="fas fa-lock"></i></div>
        </div>
        <div class="stat-value" id="totalTVL">‚Ç≥ 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Active Predictions</span>
          <div class="stat-icon"><i class="fas fa-bullseye"></i></div>
        </div>
        <div class="stat-value" id="activePredictions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Total Staked</span>
          <div class="stat-icon"><i class="fas fa-coins"></i></div>
        </div>
        <div class="stat-value" id="totalStaked">‚Ç≥ 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Unique Users</span>
          <div class="stat-icon"><i class="fas fa-user"></i></div>
        </div>
        <div class="stat-value" id="uniqueUsers">0</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Left Column - Create Prediction -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-pen-to-square"></i> Create Prediction
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Target Epoch</label>
            <div class="input-wrapper">
              <i class="fas fa-calendar input-icon"></i>
              <input id="epoch" type="number" class="form-input" placeholder="e.g., 520">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Stake (ADA)</label>
            <div class="input-wrapper">
              <i class="fas fa-lock input-icon"></i>
              <input id="stake" type="number" class="form-input" placeholder="Min 10" value="10">
            </div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Predicted Price (lovelace)</label>
            <div class="input-wrapper">
              <i class="fas fa-coins input-icon"></i>
              <input id="price" type="number" class="form-input" placeholder="750000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Oracle Address</label>
            <div class="input-wrapper">
              <i class="fas fa-user-secret input-icon"></i>
              <input id="oracle" type="text" class="form-input" 
                     value="addr_test1qzx9hu8j4ah3auytk0mwcupd69hpc52t0cw39a65ndrah86djs784u92a3m5w475w3w35tyd6v3qumkze80j8a6h5tuqq5xe8y">
            </div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button id="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Submit
          </button>
          <button id="fetchCurrent" class="btn btn-secondary">
            <i class="fas fa-sync-alt"></i> Update
          </button>
        </div>
      </div>

      <!-- Right Column - Portfolio -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-user-circle"></i> Your Portfolio
          </div>
        </div>

        <div id="disconnectedContent">
          <div style="text-align: center; padding: 32px 16px;">
            <i class="fas fa-wallet" style="font-size: 3rem; color: #38bdf8; margin-bottom: 16px;"></i>
            <h3 style="margin-bottom: 8px;">Connect Your Wallet</h3>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">Connect Lace wallet to start predicting</p>
            <button id="connect" class="btn btn-primary" style="display: inline-flex; width: auto; padding: 12px 32px;">
              <i class="fas fa-plug"></i> Connect Lace
            </button>
          </div>
        </div>

        <div id="connectedContent" style="display: none;">
          <div class="portfolio-grid">
            <div class="portfolio-item">
              <i class="fas fa-coins"></i>
              <div class="portfolio-value" id="userStaked">‚Ç≥ 0</div>
              <div style="color: var(--text-secondary);">Total Staked</div>
            </div>
            <div class="portfolio-item">
              <i class="fas fa-trophy"></i>
              <div class="portfolio-value" id="userWins">0</div>
              <div style="color: var(--text-secondary);">Wins</div>
            </div>
            <div class="portfolio-item">
              <i class="fas fa-star"></i>
              <div class="portfolio-value" id="userAccuracy">0%</div>
              <div style="color: var(--text-secondary);">Accuracy</div>
            </div>
          </div>
          <div id="predictionsList" style="margin-top: 20px;"></div>
        </div>
      </div>
    </div>

    <!-- Leaderboard -->
    <div style="margin-bottom: 32px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-trophy" style="color: #38bdf8;"></i> Top Predictors
        </h2>
        <button id="refreshData" class="btn btn-secondary" style="padding: 8px 16px;">
          <i class="fas fa-rotate"></i> Refresh
        </button>
      </div>
      <div class="card">
        <div id="leaderboard" class="leaderboard">
          <div class="skeleton" style="height: 50px; margin-bottom: 8px;"></div>
          <div class="skeleton" style="height: 50px; margin-bottom: 8px;"></div>
          <div class="skeleton" style="height: 50px;"></div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="fas fa-eye"></i> Oracle Actions</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button id="resolve" class="btn btn-success">
            <i class="fas fa-check-circle"></i> Resolve
          </button>
          <button id="checkUnresolved" class="btn btn-secondary">
            <i class="fas fa-search"></i> Check
          </button>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="fas fa-gift"></i> Claim Rewards</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button id="claim" class="btn btn-warning">
            <i class="fas fa-gift"></i> Claim
          </button>
          <button id="checkPredictions" class="btn btn-secondary">
            <i class="fas fa-wallet"></i> Check
          </button>
        </div>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <i class="fas fa-terminal"></i> Activity Log
        </div>
        <button id="clearLog" style="background: none; border: none; color: #64748b; cursor: pointer;">
          <i class="fas fa-trash-alt"></i> Clear
        </button>
      </div>
      <div id="log" class="log-container">
        <div>üöÄ Cardano Predict dApp loaded</div>
        <div>üìä Connect your Lace wallet to start</div>
      </div>
    </div>
  </div>

  <!-- Include the FULL app.js directly in the HTML -->
  <script type="module">
    import {
      Lucid,
      Blockfrost,
      Constr,
      Data,
    } from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

    // =====================================================
    // DATUM SCHEMA
    // =====================================================
    const PricePredictionDatum = Data.Object({
      ppPredictor: Data.Bytes(),
      ppTargetEpoch: Data.Integer(),
      ppPredictedPrice: Data.Integer(),
      ppStake: Data.Integer(),
      ppOracle: Data.Bytes(),
      ppResolved: Data.Boolean(),
    });

    // =====================================================
    // REDEEMERS
    // =====================================================
    const resolveRedeemer = Data.to(new Constr(1, []));
    const claimRedeemer   = Data.to(new Constr(2, []));

    // =====================================================
    // CONFIG
    // =====================================================
    const BLOCKFROST_URL = "https://cardano-preprod.blockfrost.io/api/v0";
    const BLOCKFROST_KEY = "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip";
    const NETWORK = "Preprod";

    // =====================================================
    // PLUTUS SCRIPT
    // =====================================================
    const SCRIPT_CBOR = "590c5f010000323232323233223232323232323232332232323322323232323232323232323232332232323223232323232322322323253353232325333500215335533535003222222001103013357389211770726564696374696f6e206e6f74207265736f6c7665640002f15335333573466e20ccc040ccd54c0484800488cd54c05c480048d400488cd540a0008cd54c068480048d400488cd540ac008ccd40048cc0f52000001223303e00200123303d00148000004cd54c05c480048d400488cd540a0008ccd40048cd54c06c480048d400488cd540b0008d5407400400488ccd5540600740080048cd54c06c480048d400488cd540b0008d54070004004ccd55404c0600080054088c8c8d4004888888888888ccd54c0804800488d40088888d401088cd400894cd4ccd5cd19b8f017001047046133503800600810082008503000a35002220023500322222200601b01b3500322222200302f0301030133573892010f726577617264206e6f7420706169640002f102f1533533017350012200235003222222002103013357389201186f7261636c65207369676e6174757265206d697373696e670002f153355335330173500122002350032222220061030133573892011b707265646963746f72207369676e6174757265206d697373696e670002f1533553353500122350022222222222223333500d25034250342503423335530271200150282350012253355335333573466e3cd400888008d4010880081081044ccd5cd19b873500222001350042200104204110411350380031503700d21333573466e20ccc044d4d400488004888800c070070d401088888800c0c00c44c98c80c8cd5ce24811473637269707420696e707574206d697373696e6700033103013357389201107374616b65206e6f74206c6f636b65640002f102f3333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40a80acd5d0a80619a8150159aba1500b33502a02c35742a014666aa05ceb940b4d5d0a804999aa8173ae502d35742a01066a0540706ae85401cccd540b80e5d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd410dd69aba150023044357426ae8940088c98c8120cd5ce02402482309aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a821bad35742a00460886ae84d5d1280111931902419ab9c048049046135573ca00226ea8004d5d09aba2500223263204433573808808a08426aae7940044dd50009aba1500533502a75c6ae854010ccd540b80d48004d5d0a801999aa8173ae200135742a004606e6ae84d5d1280111931902019ab9c04004103e135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a008604e6ae84d5d1280211931901919ab9c0320330303333573466e1d401520042122200323333573466e1d401920022122200223333573466e1d401d20002122200123263203333573806606806206005e6666ae68cdc39aab9d500b480008cccccc88888848cccccc00401c01801401000c008dd71aba1500b375a6ae854028dd69aba15009375a6ae854020dd71aba15007302c357426ae89401c8c98c80c0cd5ce01801881708180b09aab9e50011375400226aae74dd500089aba25001135744a00226ae8940044d55cf280089baa0012446464600200a640026aa0524466a0029000111a80111299a999ab9a3371e0040120540522600e0022600c006640026aa0504466a0029000111a80111299a999ab9a3371e00400e05205020022600c006222444666aa600824002a02666aa600e2400246a0024466aa0300046aa012002666aa600824002446a00444a66a666aa601c240026466a02244666a006440040040026a00244002246600244a66a0042052200204c46a002446601400400a00c2006266a02e008006a02800266aa600e2400246a002446466aa032006600200a640026aa05444a66a00226aa0140064426a00444a66a6601800401022444660040140082600c006004640026aa0464422444a66a00220044426600a004666aa600e2400200a0080022242444600600822424446002008640026aa040442244a66a0022a02244266a024600800466aa600c2400200800244666ae68cdc780100080e00d911a801111111111111299a999aa980789000a8081299a999ab9a3371e01c00205004e26a03c0022a03a00842050204c640026aa03a4422444a66a00226a00644002442666a00a440046008004666aa600e2400200a008002266a00244a66a004420062002a01824424660020060049101001232230023758002640026aa034446666aae7c004940288cd4024c010d5d080118019aba200201a232323333573466e1cd55cea80124000466442466002006004601e6ae854008c014d5d09aba2500223263201933573803203402e26aae7940044dd50009191919191999ab9a3370e6aae75401120002333322221233330010050040030023232323333573466e1cd55cea8012400046644246600200600460306ae854008cd404005cd5d09aba2500223263201e33573803c03e03826aae7940044dd50009aba150043335500875ca00e6ae85400cc8c8c8cccd5cd19b875001480108c84888c008010d5d09aab9e500323333573466e1d4009200223212223001004375c6ae84d55cf280211999ab9a3370ea00690001091100191931901019ab9c02002101e01d01c135573aa00226ea8004d5d0a80119a8063ae357426ae8940088c98c8068cd5ce00d00d80c09aba25001135744a00226aae7940044dd5000899aa800bae75a224464460046eac004c8004d5405c88c8cccd55cf80112804119a80399aa80498031aab9d5002300535573ca00460086ae8800c0604d5d08008891001091091198008020018891091980080180109119191999ab9a3370ea002900011a80398029aba135573ca00646666ae68cdc3a801240044a00e464c6402866ae700500540480444d55cea80089baa0011212230020031122001232323333573466e1d400520062321222230040053007357426aae79400c8cccd5cd19b875002480108c848888c008014c024d5d09aab9e500423333573466e1d400d20022321222230010053007357426aae7940148cccd5cd19b875004480008c848888c00c014dd71aba135573ca00c464c6402466ae7004804c04003c0380344d55cea80089baa001232323333573466e1cd55cea80124000466442466002006004600a6ae854008dd69aba135744a004464c6401c66ae7003803c0304d55cf280089baa0012323333573466e1cd55cea800a400046eb8d5d09aab9e500223263200c33573801801a01426ea80048c8c8c8c8c8cccd5cd19b8750014803084888888800c8cccd5cd19b875002480288488888880108cccd5cd19b875003480208cc8848888888cc004024020dd71aba15005375a6ae84d5d1280291999ab9a3370ea00890031199109111111198010048041bae35742a00e6eb8d5d09aba2500723333573466e1d40152004233221222222233006009008300c35742a0126eb8d5d09aba2500923333573466e1d40192002232122222223007008300d357426aae79402c8cccd5cd19b875007480008c848888888c014020c038d5d09aab9e500c23263201533573802a02c02602402202001e01c01a26aae7540104d55cf280189aab9e5002135573ca00226ea80048c8c8c8c8cccd5cd19b875001480088ccc888488ccc00401401000cdd69aba15004375a6ae85400cdd69aba135744a00646666ae68cdc3a80124000464244600400660106ae84d55cf280311931900719ab9c00e00f00c00b135573aa00626ae8940044d55cf280089baa001232323333573466e1d400520022321223001003375c6ae84d55cf280191999ab9a3370ea004900011909118010019bae357426aae7940108c98c802ccd5ce00580600480409aab9d50011375400224464646666ae68cdc3a800a40084244400246666ae68cdc3a8012400446424446006008600c6ae84d55cf280211999ab9a3370ea00690001091100111931900619ab9c00c00d00a009008135573aa00226ea80048c8cccd5cd19b8750014800880148cccd5cd19b8750024800080148c98c8020cd5ce00400480300289aab9d3754002244004244002932490350543100120012233700004002224646002002446600660040040021";

    const script = { type: "PlutusV2", script: SCRIPT_CBOR };

    // =====================================================
    // GLOBAL STATE
    // =====================================================
    let lucid;
    let walletAddress;
    let scriptAddress;
    let currentEpoch = null;

    // =====================================================
    // LOGGING
    // =====================================================
    function log(message, type = "info") {
      const logElement = document.getElementById("log");
      if (!logElement) return;
      
      const timestamp = new Date().toLocaleTimeString();
      let prefix = "";
      
      switch(type) {
        case "success": prefix = "‚úÖ "; break;
        case "error": prefix = "‚ùå "; break;
        case "warning": prefix = "‚ö†Ô∏è "; break;
        default: prefix = "‚ÑπÔ∏è ";
      }
      
      const logEntry = document.createElement("div");
      logEntry.style.cssText = "margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #1e293b;";
      logEntry.innerHTML = `<span style="color: #64748b;">[${timestamp}]</span> <span style="color: ${type === 'success' ? '#86efac' : type === 'error' ? '#fca5a5' : type === 'warning' ? '#fcd34d' : '#93c5fd'};">${prefix}${message}</span>`;
      
      logElement.prepend(logEntry);
      if (logElement.children.length > 15) {
        logElement.children[logElement.children.length - 1].remove();
      }
    }

    // =====================================================
    // FETCH CURRENT EPOCH
    // =====================================================
    async function fetchCurrentEpoch() {
      try {
        const response = await fetch(
          `${BLOCKFROST_URL}/epochs/latest`,
          { headers: { 'project_id': BLOCKFROST_KEY } }
        );
        
        if (response.ok) {
          const data = await response.json();
          currentEpoch = data.epoch;
          const epochInput = document.getElementById("epoch");
          if (epochInput) {
            epochInput.value = currentEpoch + 2;
          }
          log(`Current epoch: ${currentEpoch}`, "info");
          return currentEpoch;
        }
      } catch (error) {
        log(`Could not fetch epoch: ${error.message}`, "warning");
      }
      return null;
    }

    // =====================================================
    // SHORTEN ADDRESS
    // =====================================================
    function shortenAddress(addr, chars = 6) {
      if (!addr) return "";
      return `${addr.substring(0, chars)}...${addr.substring(addr.length - chars)}`;
    }

    // =====================================================
    // INIT / CONNECT
    // =====================================================
    async function init() {
      try {
        log("üîÑ Initializing...", "info");
        
        if (!window.cardano?.lace) {
          log("‚ùå Lace wallet not found. Please install it.", "error");
          alert("Please install Lace wallet extension to use this dApp.");
          return;
        }

        lucid = await Lucid.new(
          new Blockfrost(BLOCKFROST_URL, BLOCKFROST_KEY),
          NETWORK
        );

        const api = await window.cardano.lace.enable();
        lucid.selectWallet(api);

        walletAddress = await lucid.wallet.address();
        scriptAddress = lucid.utils.validatorToAddress(script);

        // Update UI
        const walletBadge = document.getElementById("walletBadge");
        if (walletBadge) {
          walletBadge.innerHTML = `
            <i class="fas fa-wallet"></i>
            <span>${shortenAddress(walletAddress)}</span>
            <span style="background: rgba(34,197,94,0.2); padding: 2px 8px; border-radius: 40px; margin-left: 8px; color: #86efac;">
              <i class="fas fa-circle" style="font-size: 0.5rem;"></i> Connected
            </span>
          `;
        }

        // Show connected content
        const disconnectedContent = document.getElementById("disconnectedContent");
        const connectedContent = document.getElementById("connectedContent");
        if (disconnectedContent) disconnectedContent.style.display = "none";
        if (connectedContent) connectedContent.style.display = "block";

        // Fetch current epoch
        await fetchCurrentEpoch();

        log(`‚úÖ Connected: ${shortenAddress(walletAddress)}`, "success");
        
        // Check collateral
        const collateral = await lucid.wallet.getCollateral();
        if (collateral.length === 0) {
          log("‚ö†Ô∏è Please set collateral in your wallet", "warning");
        }

      } catch (error) {
        log(`‚ùå Connection failed: ${error.message}`, "error");
        console.error(error);
      }
    }

    // =====================================================
    // SUBMIT PREDICTION
    // =====================================================
    async function submitPrediction() {
      if (!lucid || !walletAddress) {
        log("Please connect wallet first", "error");
        return;
      }

      try {
        const epoch = BigInt(document.getElementById("epoch").value);
        const price = BigInt(document.getElementById("price").value);
        const stakeAda = BigInt(document.getElementById("stake").value) * 1_000_000n;
        const oracleAddr = document.getElementById("oracle").value;

        if (stakeAda < 10_000_000n) {
          throw new Error("Minimum stake is 10 ADA");
        }

        const predictorPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
        const oraclePkh = lucid.utils.getAddressDetails(oracleAddr).paymentCredential.hash;

        const datum = Data.to(
          {
            ppPredictor: predictorPkh,
            ppTargetEpoch: epoch,
            ppPredictedPrice: price,
            ppStake: stakeAda,
            ppOracle: oraclePkh,
            ppResolved: false,
          },
          PricePredictionDatum
        );

        log(`Building transaction for ${stakeAda / 1_000_000n} ADA...`, "info");

        const tx = await lucid
          .newTx()
          .payToContract(
            scriptAddress,
            { inline: datum },
            { lovelace: stakeAda + 2_000_000n }
          )
          .addSigner(walletAddress)
          .complete();

        const signed = await tx.sign().complete();
        const txHash = await signed.submit();

        log(`‚úÖ Prediction submitted! TX: ${txHash}`, "success");
        document.getElementById("stake").value = "";

      } catch (error) {
        log(`‚ùå ${error.message}`, "error");
      }
    }

    // =====================================================
    // RESOLVE PREDICTION
    // =====================================================
    async function resolvePrediction() {
      if (!lucid || !walletAddress) {
        log("Please connect wallet first", "error");
        return;
      }

      try {
        const oraclePkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
        const utxos = await lucid.utxosAt(scriptAddress);

        const predictionToResolve = utxos.find((u) => {
          if (!u.datum) return false;
          try {
            const d = Data.from(u.datum, PricePredictionDatum);
            return d.ppOracle === oraclePkh && !d.ppResolved;
          } catch {
            return false;
          }
        });

        if (!predictionToResolve) {
          log("No unresolved predictions found", "info");
          return;
        }

        const oldDatum = Data.from(predictionToResolve.datum, PricePredictionDatum);
        const newDatum = Data.to(
          { ...oldDatum, ppResolved: true },
          PricePredictionDatum
        );

        const tx = await lucid
          .newTx()
          .collectFrom([predictionToResolve], resolveRedeemer)
          .attachSpendingValidator(script)
          .payToContract(
            scriptAddress,
            { inline: newDatum },
            predictionToResolve.assets
          )
          .addSigner(walletAddress)
          .complete();

        const signed = await tx.sign().complete();
        const txHash = await signed.submit();

        log(`‚úÖ Prediction resolved! TX: ${txHash}`, "success");

      } catch (error) {
        log(`‚ùå ${error.message}`, "error");
      }
    }

    // =====================================================
    // CLAIM REWARD
    // =====================================================
    async function claimReward() {
      if (!lucid || !walletAddress) {
        log("Please connect wallet first", "error");
        return;
      }

      try {
        const predictorPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
        const utxos = await lucid.utxosAt(scriptAddress);

        const claimableUtxo = utxos.find((u) => {
          if (!u.datum) return false;
          try {
            const d = Data.from(u.datum, PricePredictionDatum);
            return d.ppPredictor === predictorPkh && d.ppResolved;
          } catch {
            return false;
          }
        });

        if (!claimableUtxo) {
          log("No claimable rewards found", "info");
          return;
        }

        const datum = Data.from(claimableUtxo.datum, PricePredictionDatum);

        const tx = await lucid
          .newTx()
          .collectFrom([claimableUtxo], claimRedeemer)
          .attachSpendingValidator(script)
          .payToAddress(walletAddress, {
            lovelace: datum.ppStake,
          })
          .addSigner(walletAddress)
          .complete();

        const signed = await tx.sign().complete();
        const txHash = await signed.submit();

        const rewardAda = datum.ppStake / 1_000_000n;
        log(`üí∞ Reward claimed: ${rewardAda} ADA! TX: ${txHash}`, "success");

      } catch (error) {
        log(`‚ùå ${error.message}`, "error");
      }
    }

    // =====================================================
    // CHECK FUNCTIONS
    // =====================================================
    async function checkMyPredictions() {
      if (!lucid || !walletAddress) {
        log("Please connect wallet first", "error");
        return;
      }
      log("Checking your predictions...", "info");
    }

    async function checkUnresolvedPredictions() {
      if (!lucid || !walletAddress) {
        log("Please connect wallet first", "error");
        return;
      }
      log("Checking unresolved predictions...", "info");
    }

    // =====================================================
    // EVENT LISTENERS
    // =====================================================
    document.addEventListener("DOMContentLoaded", () => {
      log("üöÄ Cardano Predict dApp loaded", "success");
      log("üìä Connect your Lace wallet to start", "info");
      
      fetchCurrentEpoch();

      // Set up event listeners
      document.getElementById("connect")?.addEventListener("click", init);
      document.getElementById("submit")?.addEventListener("click", submitPrediction);
      document.getElementById("resolve")?.addEventListener("click", resolvePrediction);
      document.getElementById("claim")?.addEventListener("click", claimReward);
      document.getElementById("fetchCurrent")?.addEventListener("click", fetchCurrentEpoch);
      document.getElementById("checkPredictions")?.addEventListener("click", checkMyPredictions);
      document.getElementById("checkUnresolved")?.addEventListener("click", checkUnresolvedPredictions);
      document.getElementById("refreshData")?.addEventListener("click", fetchCurrentEpoch);
      document.getElementById("clearLog")?.addEventListener("click", () => {
        const logEl = document.getElementById("log");
        if (logEl) logEl.innerHTML = "";
        log("Log cleared", "info");
      });
    });

    // Export for debugging
    window.app = { init, submitPrediction, resolvePrediction, claimReward, log };
  </script>
</body>
</html>
